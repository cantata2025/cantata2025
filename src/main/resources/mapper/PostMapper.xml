<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cantata.tradetalent.repository.PostRepository">

    <!-- 게시글 등록 쿼리 -->
    <insert id="savePost" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO posts (region, category_id_give, category_id_take, content, writer)
        VALUES (
        (SELECT id FROM region_categories
        WHERE region_group_name = #{region}
        AND province_name = #{province}
        AND district_name = #{district}) ,
        (SELECT id FROM categories WHERE sub_category_name =#{subCategoryName}),
        (SELECT id FROM categories WHERE sub_category_name =#{subCategoryName}),
        #{content}, #{email}
        )
    </insert>

    <!-- 게시물 수정 쿼리 -->
    <update id="updatePost">
        UPDATE posts
        SET content = #{content}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 게시물 모두 조회 쿼리 -->
    <select id="findAllPost" resultType="Post">
        SELECT *
        FROM posts
        <!-- 삭제되지 않은 게시글만 조회 -->
        WHERE deleted_at IS NULL
        ORDER BY created_at DESC, id DESC;
    </select>

    <!-- 게시물 삭제 쿼리 -->
    <update id="deletePost">
        UPDATE posts
        SET deleted_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 게시물 조회수 증가 쿼리 -->
    <update id="increaseViewCount">
        UPDATE posts
        SET view_count = view_count + 1
        WHERE id = #{id};
    </update>
</mapper>
