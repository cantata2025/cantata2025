<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cantata.tradetalent.repository.PostRepository">

    <!-- 게시글 등록 쿼리 -->
    <insert id="savePost" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO posts (region, category_id_give, category_id_take, content, writer)
        VALUES (
        (SELECT id FROM region_categories
        WHERE region_group_name = #{region}
        AND province_name = #{province}
        AND district_name = #{district}) ,
        (SELECT id FROM categories WHERE sub_category_name =#{categoryGive}),
        (SELECT id FROM categories WHERE sub_category_name =#{categoryTake}),
        #{content}, #{email}
        )
    </insert>

    <!-- 게시물 수정 쿼리 -->
    <update id="updatePost">
        UPDATE posts
        SET content = #{content}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 게시물 모두 조회 쿼리 -->
    <select id="findAllPost" resultType="Post">
        SELECT *
        FROM posts
        <!-- 삭제되지 않은 게시글만 조회 -->
        WHERE deleted_at IS NULL
        ORDER BY created_at DESC, id DESC;
    </select>

    <!-- 게시물 키워드 조회  -->
    <select id="findByKeyword" resultType="SearchResponse">
        SELECT p.id,
            region.region_group_name AS regionName,
            region.province_name AS provinceName,
            region.district_name AS districtName,
            give_category.sub_category_name AS categoryNameGive,
            take_category.sub_category_name AS categoryNameTake,
            p.content,
            p.writer,
            p.view_count AS viewCount,
            p.created_at AS createdAt
        FROM posts p
        LEFT JOIN categories give_category ON p.category_id_give = give_category.id
        LEFT JOIN categories take_category ON p.category_id_take = take_category.id
        LEFT JOIN region_categories region ON p.region = region.id
        WHERE 1=1
        AND deleted_at IS NULL

        <choose>
            <when test="option == 'content'">
                AND p.content LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="option == 'giveCategory'">
                AND give_category.sub_category_name LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="option == 'takeCategory'">
                AND take_category.sub_category_name LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="option == 'region'">
                AND (
                region.region_group_name LIKE CONCAT('%', #{keyword}, '%')
                OR region.province_name LIKE CONCAT('%', #{keyword}, '%')
                OR region.district_name LIKE CONCAT('%', #{keyword}, '%')
                )
            </when>
        </choose>
    </select>



    <!-- 게시물 삭제 쿼리 -->
    <update id="deletePost">
        UPDATE posts
        SET deleted_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 게시물 조회수 증가 쿼리 -->
    <update id="increaseViewCount">
        UPDATE posts
        SET view_count = view_count + 1
        WHERE id = #{id};
    </update>
</mapper>
